{% comment %}
Data Table Component
Usage: {% include "components/data_table.html" with table_data=your_data table_columns=your_columns %}
{% endcomment %}

<div class="bg-white rounded-2xl shadow-md overflow-hidden">
    <!-- Table Header with Actions -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <!-- Title and Description -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900">{{ table_title|default:"Data Table" }}</h3>
                {% if table_description %}
                <p class="text-sm text-gray-600 mt-1">{{ table_description }}</p>
                {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-3">
                <!-- Search -->
                {% if show_search %}
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <input type="text" id="table-search" placeholder="Search..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                </div>
                {% endif %}
                
                <!-- Filter -->
                {% if show_filter %}
                <select id="table-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <option value="">All</option>
                    {% for filter_option in filter_options %}
                    <option value="{{ filter_option.value }}">{{ filter_option.label }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                
                <!-- Add Button -->
                {% if add_url %}
                <a href="{{ add_url }}" class="btn-primary text-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    {{ add_button_text|default:"Add New" }}
                </a>
                {% endif %}
                
                <!-- Export -->
                {% if show_export %}
                <div class="relative">
                    <button id="export-dropdown" class="btn-secondary text-sm">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        Export
                        <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                    </button>
                    <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-export="csv">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>
                            Export as CSV
                        </a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-export="excel">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>
                            Export as Excel
                        </a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-export="pdf">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>
                            Export as PDF
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Table Content -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="data-table">
            <thead class="bg-gray-50 sticky top-0">
                <tr>
                    {% for column in table_columns %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-200"
                        data-sort="{{ column.key }}" data-type="{{ column.type|default:'string' }}">
                        <div class="flex items-center space-x-1">
                            <span>{{ column.label }}</span>
                            {% if column.sortable %}
                            <i data-lucide="chevron-up" class="w-4 h-4 text-gray-400 sort-icon"></i>
                            {% endif %}
                        </div>
                    </th>
                    {% endfor %}
                    
                    <!-- Actions Column -->
                    {% if show_actions %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for row in table_data %}
                <tr class="hover:bg-gray-50 transition-colors duration-200" data-row-id="{{ row.id }}">
                    {% for column in table_columns %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if column.type == 'image' %}
                        <div class="flex items-center">
                            {% if row|get_item:column.key %}
                            <img src="{{ row|get_item:column.key }}" alt="{{ column.label }}" 
                                 class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            {% endif %}
                        </div>
                        {% elif column.type == 'status' %}
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            {% if row|get_item:column.key == 'active' or row|get_item:column.key == 'completed' %}bg-success-100 text-success-800
                            {% elif row|get_item:column.key == 'pending' %}bg-amber-100 text-amber-800
                            {% elif row|get_item:column.key == 'inactive' or row|get_item:column.key == 'failed' %}bg-error-100 text-error-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ row|get_item:column.key|title }}
                        </span>
                        {% elif column.type == 'date' %}
                        <span class="text-sm text-gray-900">{{ row|get_item:column.key|date:"M d, Y" }}</span>
                        {% elif column.type == 'datetime' %}
                        <span class="text-sm text-gray-900">{{ row|get_item:column.key|date:"M d, Y H:i" }}</span>
                        {% elif column.type == 'currency' %}
                        <span class="text-sm font-medium text-gray-900">KES {{ row|get_item:column.key|floatformat:0 }}</span>
                        {% elif column.type == 'percentage' %}
                        <span class="text-sm font-medium text-gray-900">{{ row|get_item:column.key|floatformat:1 }}%</span>
                        {% elif column.type == 'boolean' %}
                        <span class="inline-flex items-center">
                            {% if row|get_item:column.key %}
                            <i data-lucide="check-circle" class="w-5 h-5 text-success-600"></i>
                            {% else %}
                            <i data-lucide="x-circle" class="w-5 h-5 text-error-600"></i>
                            {% endif %}
                        </span>
                        {% elif column.type == 'link' %}
                        <a href="{{ row|get_item:column.key }}" class="text-primary-600 hover:text-primary-900 font-medium">
                            {{ row|get_item:column.label|default:"View" }}
                        </a>
                        {% else %}
                        <span class="text-sm text-gray-900">{{ row|get_item:column.key }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    
                    <!-- Actions Column -->
                    {% if show_actions %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-2">
                            {% if view_url %}
                            <a href="{{ view_url|add:row.id }}" class="text-primary-600 hover:text-primary-900" title="View">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </a>
                            {% endif %}
                            
                            {% if edit_url %}
                            <a href="{{ edit_url|add:row.id }}" class="text-amber-600 hover:text-amber-900" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </a>
                            {% endif %}
                            
                            {% if delete_url %}
                            <button onclick="deleteRow('{{ row.id }}', '{{ delete_url }}')" 
                                    class="text-error-600 hover:text-error-900" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            {% endif %}
                            
                            <!-- Custom Actions -->
                            {% for action in custom_actions %}
                            <a href="{{ action.url|add:row.id }}" 
                               class="text-{{ action.color|default:'primary' }}-600 hover:text-{{ action.color|default:'primary' }}-900" 
                               title="{{ action.title }}">
                                <i data-lucide="{{ action.icon }}" class="w-4 h-4"></i>
                            </a>
                            {% endfor %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ table_columns|length|add:show_actions|yesno:'1,0' }}" class="px-6 py-12 text-center">
                        <div class="text-gray-500">
                            <i data-lucide="inbox" class="w-16 h-16 text-gray-400 mx-auto mb-3"></i>
                            <p class="text-lg font-medium">No data available</p>
                            <p class="text-sm">There are no records to display at the moment.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination %}
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <!-- Results Info -->
            <div class="text-sm text-gray-700">
                Showing {{ pagination.start_index }} to {{ pagination.end_index }} of {{ pagination.total_count }} results
            </div>
            
            <!-- Pagination Controls -->
            <div class="flex items-center space-x-2">
                {% if pagination.has_previous %}
                <a href="?page={{ pagination.previous_page_number }}" class="btn-secondary text-sm">
                    <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>
                    Previous
                </a>
                {% endif %}
                
                <!-- Page Numbers -->
                <div class="flex items-center space-x-1">
                    {% for page_num in pagination.page_range %}
                    {% if page_num == pagination.number %}
                    <span class="px-3 py-2 text-sm font-medium text-primary-600 bg-primary-100 rounded-lg">
                        {{ page_num }}
                    </span>
                    {% elif page_num == pagination.number|add:'-1' or page_num == pagination.number|add:'1' %}
                    <a href="?page={{ page_num }}" class="px-3 py-2 text-sm text-gray-700 hover:text-primary-600 hover:bg-primary-50 rounded-lg">
                        {{ page_num }}
                    </a>
                    {% elif page_num == 1 or page_num == pagination.paginator.num_pages %}
                    <a href="?page={{ page_num }}" class="px-3 py-2 text-sm text-gray-700 hover:text-primary-600 hover:bg-primary-50 rounded-lg">
                        {{ page_num }}
                    </a>
                    {% elif page_num == pagination.number|add:'-2' or page_num == pagination.number|add:'2' %}
                    <span class="px-3 py-2 text-sm text-gray-400">...</span>
                    {% endif %}
                    {% endfor %}
                </div>
                
                {% if pagination.has_next %}
                <a href="?page={{ pagination.next_page_number }}" class="btn-secondary text-sm">
                    Next
                    <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Table JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('data-table');
    const searchInput = document.getElementById('table-search');
    const filterSelect = document.getElementById('table-filter');
    const exportDropdown = document.getElementById('export-dropdown');
    const exportMenu = document.getElementById('export-menu');
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Filter functionality
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            const filterValue = this.value;
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                if (!filterValue || row.dataset.status === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Export dropdown
    if (exportDropdown && exportMenu) {
        exportDropdown.addEventListener('click', function() {
            exportMenu.classList.toggle('hidden');
        });
        
        // Close export menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!exportDropdown.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.add('hidden');
            }
        });
        
        // Export functionality
        exportMenu.addEventListener('click', function(e) {
            if (e.target.dataset.export) {
                const format = e.target.dataset.export;
                exportTable(format);
                exportMenu.classList.add('hidden');
            }
        });
    }
    
    // Sorting functionality
    const sortableHeaders = table.querySelectorAll('th[data-sort]');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const columnKey = this.dataset.sort;
            const dataType = this.dataset.type;
            sortTable(columnKey, dataType);
            
            // Update sort icons
            sortableHeaders.forEach(h => {
                h.querySelector('.sort-icon').setAttribute('data-lucide', 'chevron-up');
            });
            
            // Toggle sort direction
            const currentIcon = this.querySelector('.sort-icon');
            if (currentIcon.getAttribute('data-lucide') === 'chevron-up') {
                currentIcon.setAttribute('data-lucide', 'chevron-down');
            } else {
                currentIcon.setAttribute('data-lucide', 'chevron-up');
            }
            
            // Recreate icons
            lucide.createIcons();
        });
    });
    
    function sortTable(columnKey, dataType) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aValue = getCellValue(a, columnKey);
            const bValue = getCellValue(b, columnKey);
            
            if (dataType === 'number') {
                return parseFloat(aValue) - parseFloat(bValue);
            } else if (dataType === 'date') {
                return new Date(aValue) - new Date(bValue);
            } else {
                return aValue.localeCompare(bValue);
            }
        });
        
        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function getCellValue(row, columnKey) {
        const columnIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.sort === columnKey);
        if (columnIndex >= 0) {
            return row.cells[columnIndex].textContent.trim();
        }
        return '';
    }
    
    function exportTable(format) {
        const tableData = [];
        const headers = [];
        
        // Get headers
        table.querySelectorAll('thead th').forEach(th => {
            if (th.dataset.sort) {
                headers.push(th.textContent.trim());
            }
        });
        
        // Get data
        table.querySelectorAll('tbody tr').forEach(row => {
            const rowData = [];
            row.querySelectorAll('td').forEach((td, index) => {
                if (index < headers.length) {
                    rowData.push(td.textContent.trim());
                }
            });
            tableData.push(rowData);
        });
        
        // Export based on format
        switch (format) {
            case 'csv':
                exportCSV(headers, tableData);
                break;
            case 'excel':
                exportExcel(headers, tableData);
                break;
            case 'pdf':
                exportPDF(headers, tableData);
                break;
        }
    }
    
    function exportCSV(headers, data) {
        const csvContent = [headers.join(','), ...data.map(row => row.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'table_data.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
    
    function exportExcel(headers, data) {
        // This would require a library like SheetJS
        showToast('Excel export requires additional setup', 'info');
    }
    
    function exportPDF(headers, data) {
        // This would require a library like jsPDF
        showToast('PDF export requires additional setup', 'info');
    }
});

// Delete row function
function deleteRow(rowId, deleteUrl) {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        fetch(`${deleteUrl}${rowId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (response.ok) {
                document.querySelector(`[data-row-id="${rowId}"]`).remove();
                showToast('Item deleted successfully', 'success');
            } else {
                showToast('Failed to delete item', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while deleting', 'error');
        });
    }
}
</script>
