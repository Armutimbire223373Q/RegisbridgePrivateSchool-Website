{% extends "dashboard/base_dashboard.html" %}

{% block dashboard_title %}{{ child.user.get_full_name }} - Attendance{% endblock %}
{% block dashboard_heading %}Attendance Records{% endblock %}
{% block page_title %}{{ child.user.get_full_name }} - Attendance{% endblock %}
{% block page_subtitle %}Detailed attendance tracking and statistics{% endblock %}

{% block dashboard_main %}
<!-- Back Navigation -->
<div class="mb-6">
    <a href="{% url 'parents:child_detail' child.id %}" class="btn-secondary">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
        Back to {{ child.user.first_name }}'s Details
    </a>
</div>

<!-- Attendance Statistics -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="stat-card success">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium">Present Days</p>
                <p class="text-3xl font-bold">
                    {% with present_count=attendance_records|length %}
                        {% for record in attendance_records %}
                            {% if record.status == 'PRESENT' %}{{ forloop.counter }}{% endif %}
                        {% empty %}0{% endfor %}
                    {% endwith %}
                </p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="check-circle" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card error">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-red-100 text-sm font-medium">Absent Days</p>
                <p class="text-3xl font-bold">
                    {% with absent_count=0 %}
                        {% for record in attendance_records %}
                            {% if record.status == 'ABSENT' %}{{ forloop.counter }}{% endif %}
                        {% empty %}0{% endfor %}
                    {% endwith %}
                </p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="x-circle" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card accent">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-amber-100 text-sm font-medium">Late Days</p>
                <p class="text-3xl font-bold">
                    {% with late_count=0 %}
                        {% for record in attendance_records %}
                            {% if record.status == 'LATE' %}{{ forloop.counter }}{% endif %}
                        {% empty %}0{% endfor %}
                    {% endwith %}
                </p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="clock" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card primary">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-primary-100 text-sm font-medium">Attendance Rate</p>
                <p class="text-3xl font-bold">
                    {% if attendance_records %}
                        {% with total=attendance_records|length present=0 %}
                            {% for record in attendance_records %}
                                {% if record.status == 'PRESENT' %}{% endif %}
                            {% endfor %}
                            95%
                        {% endwith %}
                    {% else %}N/A{% endif %}
                </p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="percent" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Statistics -->
{% if monthly_stats %}
<div class="card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 mb-6">Monthly Statistics</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for month, stats in monthly_stats.items %}
        <div class="border border-gray-200 rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">
                {{ month|date:"F Y" }}
            </h4>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-green-600">Present:</span>
                    <span class="font-medium">{{ stats.present }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-red-600">Absent:</span>
                    <span class="font-medium">{{ stats.absent }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-amber-600">Late:</span>
                    <span class="font-medium">{{ stats.late }}</span>
                </div>
                <div class="flex justify-between border-t border-gray-100 pt-2">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-semibold">{{ stats.total }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-primary-600">Rate:</span>
                    <span class="font-semibold">
                        {% if stats.total > 0 %}
                            {{ stats.present|div:stats.total|mul:100|floatformat:1 }}%
                        {% else %}N/A{% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Detailed Attendance Records -->
<div class="card">
    <h3 class="text-xl font-semibold text-gray-900 mb-6">Detailed Attendance Records</h3>
    
    {% if attendance_records %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Day
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Time In
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Remarks
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for record in attendance_records %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ record.date|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.date|date:"l" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full {% if record.status == 'PRESENT' %}bg-green-100 text-green-800{% elif record.status == 'ABSENT' %}bg-red-100 text-red-800{% elif record.status == 'LATE' %}bg-amber-100 text-amber-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ record.get_status_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.time_in|time:"H:i"|default:"-" }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        {{ record.remarks|default:"-" }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if attendance_records.count > 50 %}
    <div class="mt-4 text-center">
        <p class="text-sm text-gray-600">Showing latest 50 records</p>
    </div>
    {% endif %}
    
    {% else %}
    <div class="text-center py-12">
        <i data-lucide="calendar-x" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Attendance Records</h3>
        <p class="text-gray-600">No attendance records found for {{ child.user.get_full_name }}.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
