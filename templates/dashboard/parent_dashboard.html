{% extends "dashboard/base_dashboard.html" %}

{% block dashboard_title %}Parent Dashboard{% endblock %}
{% block dashboard_heading %}Parent Portal{% endblock %}
{% block page_title %}Parent Dashboard{% endblock %}
{% block page_subtitle %}Monitor your children's progress and manage family account{% endblock %}

{% block dashboard_main %}
<!-- Parent Stats Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Number of Children -->
    <div class="stat-card primary">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-primary-100 text-sm font-medium">My Children</p>
                <p class="text-3xl font-bold">{{ children_count|default:"0" }}</p>
                <p class="text-primary-100 text-sm">Enrolled students</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="heart" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <!-- Outstanding Fees -->
    <div class="stat-card accent">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-amber-100 text-sm font-medium">Outstanding Fees</p>
                <p class="text-3xl font-bold">KES {{ outstanding_fees|default:"0"|floatformat:0 }}</p>
                <p class="text-amber-100 text-sm">Total due</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="credit-card" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <!-- Average Attendance -->
    <div class="stat-card secondary">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium">Avg Attendance</p>
                <p class="text-3xl font-bold">{{ avg_attendance|default:"0" }}%</p>
                <p class="text-blue-100 text-sm">All children</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="calendar-check" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
    
    <!-- Unread Messages -->
    <div class="stat-card success">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium">Messages</p>
                <p class="text-3xl font-bold">{{ unread_messages|default:"0" }}</p>
                <p class="text-green-100 text-sm">Unread</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3">
                <i data-lucide="mail" class="w-8 h-8 text-white"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- View Children -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">My Children</h3>
        <p class="text-gray-600 mb-4">View academic progress and performance</p>
        <a href="{% url 'parents:children_list' %}" class="btn-primary w-full">View Progress</a>
    </div>
    
    <!-- Pay Fees -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pay Fees</h3>
        <p class="text-gray-600 mb-4">Make payments for school fees</p>
        <a href="{% url 'fees:fees_student_invoices' %}" class="btn-secondary w-full">Pay Now</a>
    </div>
    
    <!-- Contact Teachers -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Teachers</h3>
        <p class="text-gray-600 mb-4">Send messages to teachers</p>
        <a href="#" class="btn-accent w-full">Send Message</a>
    </div>
</div>

<!-- Children Overview -->
<div class="card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 mb-6">My Children</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for child in children %}
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                    <span class="text-primary-600 font-medium text-sm">{{ child.user.first_name|first|upper }}{{ child.user.last_name|first|upper }}</span>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900">{{ child.user.get_full_name }}</h4>
                    <p class="text-sm text-gray-500">{{ child.class_room.name|default:"Not Assigned" }}</p>
                </div>
            </div>
            
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Attendance:</span>
                    <span class="font-medium {% if child.attendance_rate >= 90 %}text-success-600{% elif child.attendance_rate >= 80 %}text-amber-600{% else %}text-error-600{% endif %}">
                        {{ child.attendance_rate|default:"0" }}%
                    </span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Average Grade:</span>
                    <span class="font-medium {% if child.average_grade >= 80 %}text-success-600{% elif child.average_grade >= 70 %}text-amber-600{% else %}text-error-600{% endif %}">
                        {{ child.average_grade|default:"0" }}%
                    </span>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <a href="{% url 'parents:child_detail' child.id %}" class="text-primary-600 hover:text-primary-700 text-sm">Progress</a>
                <a href="{% url 'parents:child_grades' child.id %}" class="text-gray-600 hover:text-gray-700 text-sm">Grades</a>
                <form method="get" action="{% url 'grades:download_grade_pdf' child.id %}" class="flex items-center space-x-2">
                    <select name="term_id" class="border rounded px-2 py-1 text-sm">
                        <option value="">All Terms</option>
                        {% for t in terms %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="text-gray-600 hover:text-gray-700 text-sm">Download PDF</button>
                </form>
                <a href="{% url 'parents:child_attendance' child.id %}" class="text-gray-600 hover:text-gray-700 text-sm">Attendance</a>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8">
            <i data-lucide="users" class="w-16 h-16 text-gray-400 mx-auto mb-3"></i>
            <p class="text-gray-500">No children registered yet</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Financial Overview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Fee Summary -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Fee Summary</h3>
        <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                    <span class="text-gray-700">Paid This Term</span>
                </div>
                <span class="font-semibold text-green-600">KES {{ paid_fees|default:"0"|floatformat:0 }}</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="clock" class="w-5 h-5 text-amber-600 mr-2"></i>
                    <span class="text-gray-700">Pending Payment</span>
                </div>
                <span class="font-semibold text-amber-600">KES {{ pending_fees|default:"0"|floatformat:0 }}</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 mr-2"></i>
                    <span class="text-gray-700">Overdue</span>
                </div>
                <span class="font-semibold text-red-600">KES {{ overdue_fees|default:"0"|floatformat:0 }}</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="calendar" class="w-5 h-5 text-blue-600 mr-2"></i>
                    <span class="text-gray-700">Next Due Date</span>
                </div>
                <span class="font-semibold text-blue-600">{{ next_due_date|default:"N/A"|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>
    
    <!-- Recent Payments -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Payments</h3>
        <div class="space-y-3">
            {% for payment in recent_payments|slice:":5" %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-900">{{ payment.invoice.student.user.get_full_name }}</p>
                    <p class="text-sm text-gray-500">{{ payment.payment_date|date:"M d, Y" }}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-gray-900">KES {{ payment.amount|floatformat:0 }}</p>
                    <span class="text-xs bg-success-100 text-success-800 px-2 py-1 rounded-full">{{ payment.get_status_display }}</span>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-4">No recent payments</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Academic Updates -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Recent Grades -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Academic Updates</h3>
        <div class="space-y-3">
            {% for update in academic_updates|slice:":5" %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-900">{{ update.student.user.get_full_name }}</p>
                    <p class="text-sm text-gray-500">{{ update.subject.name }} â€¢ {{ update.assignment.title }}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-gray-900">{{ update.marks_obtained }}/{{ update.assignment.max_marks }}</p>
                    <span class="text-xs bg-primary-100 text-primary-800 px-2 py-1 rounded-full">{{ update.percentage|floatformat:1 }}%</span>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-4">No recent academic updates</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Attendance Summary -->
    <div class="card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Attendance Summary</h3>
        <div class="space-y-3">
            {% for attendance in attendance_summary|slice:":5" %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-900">{{ attendance.student.user.get_full_name }}</p>
                    <p class="text-sm text-gray-500">{{ attendance.date|date:"M d, Y" }}</p>
                </div>
                <div class="text-right">
                    <span class="text-xs px-2 py-1 rounded-full {% if attendance.status == 'PRESENT' %}bg-success-100 text-success-800{% elif attendance.status == 'ABSENT' %}bg-error-100 text-error-800{% else %}bg-amber-100 text-amber-800{% endif %}">
                        {{ attendance.get_status_display }}
                    </span>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-4">No recent attendance records</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Communication Center -->
<div class="card">
    <h3 class="text-xl font-semibold text-gray-900 mb-4">Communication Center</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center p-6 bg-primary-50 rounded-lg">
            <i data-lucide="mail" class="w-12 h-12 text-primary-600 mx-auto mb-3"></i>
            <h4 class="font-semibold text-gray-900 mb-2">Messages</h4>
            <p class="text-sm text-gray-600 mb-4">Stay connected with teachers</p>
            <a href="#" class="btn-primary">View Messages</a>
        </div>
        
        <div class="text-center p-6 bg-accent-50 rounded-lg">
            <i data-lucide="bell" class="w-12 h-12 text-accent-600 mx-auto mb-3"></i>
            <h4 class="font-semibold text-gray-900 mb-2">Notifications</h4>
            <p class="text-sm text-gray-600 mb-4">Get important updates</p>
            <a href="#" class="btn-accent">View Alerts</a>
        </div>
        
        <div class="text-center p-6 bg-success-50 rounded-lg">
            <i data-lucide="calendar" class="w-12 h-12 text-success-600 mx-auto mb-3"></i>
            <h4 class="font-semibold text-gray-900 mb-2">Events</h4>
            <p class="text-sm text-gray-600 mb-4">School calendar & events</p>
            <a href="#" class="btn-success">View Calendar</a>
        </div>
    </div>
</div>
{% endblock %}
